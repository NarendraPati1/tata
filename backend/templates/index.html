<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸš› SwarmSync AI Fleet Management</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>ðŸš› SwarmSync AI Fleet</h3>
            <p>Initializing AI-powered fleet management...</p>
            <p>Loading routing services...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1><i class="fas fa-truck"></i> SwarmSync AI Fleet</h1>
                <p>AI-powered truck fleet management for logistics</p>
            </div>
            <div class="header-controls">
                <div class="api-key-section">
                    <input id="api-key" type="text" placeholder="Enter OpenRouteService API Key" class="api-key-input">
                    <button onclick="saveApiKey()" class="btn btn-success">
                        <i class="fas fa-key"></i> Save Key
                    </button>
                </div>
                <button class="btn btn-secondary" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i> Menu
                </button>
                <button class="btn btn-info" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i> Help
                </button>
                <button class="btn btn-primary" onclick="resetSystem()">
                    <i class="fas fa-refresh"></i> Reset
                </button>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- Enhanced Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- AI Status -->
            <div class="sidebar-section">
                <h3><i class="fas fa-robot"></i> AI System Status</h3>
                <div class="ai-status-card">
                    <div class="status-indicator active">
                        <div class="status-dot"></div>
                        <span>AI Model Active</span>
                    </div>
                    <div class="model-info">
                        <p><strong>Model:</strong> Random Forest</p>
                        <p><strong>Accuracy:</strong> <span id="modelAccuracy">--</span></p>
                        <p><strong>Features:</strong> 4 parameters</p>
                    </div>
                </div>
            </div>

            <!-- Fleet Statistics -->
            <div class="sidebar-section">
                <h3><i class="fas fa-chart-bar"></i> Fleet Overview</h3>
                <div class="fleet-stats">
                    <div class="stat-card active">
                        <span class="stat-number" id="activeCount">--</span>
                        <span class="stat-label">Active</span>
                    </div>
                    <div class="stat-card available">
                        <span class="stat-number" id="availableCount">--</span>
                        <span class="stat-label">Available</span>
                    </div>
                    <div class="stat-card dispatched">
                        <span class="stat-number" id="dispatchedCount">0</span>
                        <span class="stat-label">Dispatched</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">15</span>
                        <span class="stat-label">Total Trucks</span>
                    </div>
                </div>
            </div>

            <!-- Emergency Breakdown Section -->
            <div class="sidebar-section">
                <h3><i class="fas fa-exclamation-triangle"></i> Emergency Response</h3>
                <div class="breakdown-panel" id="breakdownPanel">
                    <div class="instruction-text">
                        Click on the map to report a truck breakdown and get AI-powered rescue recommendations
                    </div>
                </div>
            </div>

            <!-- ML Selection Panel -->
            <div class="sidebar-section">
                <h3><i class="fas fa-brain"></i> AI Truck Selection</h3>
                <div class="ml-selection-panel" id="mlSelectionPanel">
                    <div class="instruction-text">
                        Report a breakdown to see AI-powered truck recommendations with ML scores
                    </div>
                </div>
            </div>

            <!-- Truck List -->
            <div class="sidebar-section">
                <h3><i class="fas fa-truck"></i> Fleet Status</h3>
                <div class="vehicle-list" id="vehicleList">
                    <!-- Trucks will be populated by JavaScript -->
                </div>
            </div>
        </aside>

        <!-- Map Section -->
        <main class="map-container">
            <div class="map-section">
                <div id="map"></div>
                
                <!-- Map Controls -->
                <div class="map-controls">
                    <div class="control-group">
                        <button class="control-button" onclick="centerMap()">
                            <i class="fas fa-crosshairs"></i> Center Map
                        </button>
                        <button class="control-button" onclick="toggleTraffic()">
                            <i class="fas fa-road"></i> Toggle Traffic
                        </button>
                        <button class="control-button" onclick="clearAllRoutes()">
                            <i class="fas fa-eraser"></i> Clear Routes
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Breakdown Modal -->
    <div id="breakdownModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-wrench"></i> Report Truck Breakdown</h4>
                <button class="modal-close" onclick="closeBreakdownModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form class="breakdown-form" id="breakdownForm">
                    <div class="form-group">
                        <label class="form-label">Breakdown Location</label>
                        <div class="location-display" id="locationDisplay">
                            Click on the map to select breakdown location
                        </div>
                        <p class="form-text">Click anywhere on the map to set the breakdown location</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="issueType">Issue Type</label>
                        <select class="form-control" id="issueType" required>
                            <option value="">Select issue type</option>
                            <option value="engine">Engine Failure</option>
                            <option value="tire">Tire Puncture</option>
                            <option value="brake">Brake Issues</option>
                            <option value="electrical">Electrical Problems</option>
                            <option value="fuel">Fuel System</option>
                            <option value="transmission">Transmission</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="urgencyLevel">Urgency Level</label>
                        <select class="form-control" id="urgencyLevel" required>
                            <option value="">Select urgency</option>
                            <option value="high">High - Immediate assistance needed</option>
                            <option value="medium">Medium - Can wait 30 minutes</option>
                            <option value="low">Low - Not urgent</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="description">Additional Details</label>
                        <textarea class="form-control" id="description" rows="3" 
                                placeholder="Describe the issue in detail..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBreakdownModal()">
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="findBestTruck()">
                    <i class="fas fa-search"></i> Find Best Truck
                </button>
            </div>
        </div>
    </div>

    <!-- ML Results Modal -->
    <div id="mlResultsModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h4><i class="fas fa-robot"></i> AI Truck Recommendations</h4>
                <button class="modal-close" onclick="closeMlResultsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="ml-results" id="mlResults">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeMlResultsModal()">
                    Close
                </button>
                <button type="button" class="btn btn-success" id="dispatchBtn" onclick="dispatchSelectedTruck()" disabled>
                    <i class="fas fa-paper-plane"></i> Dispatch Selected Truck
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4><i class="fas fa-check-circle"></i> Truck Dispatched Successfully</h4>
                <button class="modal-close" onclick="closeSuccessModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="success-message">
                    <div class="success-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <h4 id="successTruckId">Truck PUN-001</h4>
                    <p>has been dispatched to the breakdown location</p>
                    <div class="truck-details" id="successDetails">
                        <!-- Details will be populated -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeSuccessModal()">
                    <i class="fas fa-check"></i> Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h4><i class="fas fa-question-circle"></i> How to Use SwarmSync AI Fleet</h4>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h5>ðŸš› Fleet Management Features</h5>
                <ul>
                    <li><strong>Real-time Tracking:</strong> View all trucks on the interactive map</li>
                    <li><strong>AI-Powered Dispatch:</strong> Get ML-based truck recommendations</li>
                    <li><strong>Emergency Response:</strong> Quick breakdown reporting and response</li>
                    <li><strong>Route Optimization:</strong> Real-world routing with OpenRouteService</li>
                </ul>
                
                <h5>ðŸŽ¯ How to Report a Breakdown</h5>
                <ol>
                    <li>Enter your OpenRouteService API key in the header</li>
                    <li>Click anywhere on the map to set breakdown location</li>
                    <li>Fill in the breakdown details form</li>
                    <li>Click "Find Best Truck" for AI recommendations</li>
                    <li>Select the best truck and dispatch</li>
                </ol>
                
                <h5>ðŸ¤– AI Scoring System</h5>
                <p>Our ML model considers 12 factors including distance, fuel level, maintenance score, driver rating, and more to recommend the best truck for each emergency.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeHelpModal()">
                    <i class="fas fa-check"></i> Got it!
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='app.js') }}"></script>
    
    <script>
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš› Initializing SwarmSync AI Fleet Management...');
            
            // Hide loading screen after 2 seconds
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.classList.add('hidden');
                
                // Initialize the fleet manager
                window.fleetManager = new AIFleetManager();
                
                console.log('âœ… SwarmSync AI Fleet Management Ready!');
            }, 2000);
        });

        // API Key Management Functions (Global)
        let orsApiKey = '';

        function saveApiKey() {
            const key = document.getElementById('api-key').value.trim();
            if (!key) return alert('Please enter your OpenRouteService API key');
            orsApiKey = key;
            localStorage.setItem('ors_api_key', key);
            alert('API key saved successfully! You can now use routing features.');
            
            // Enable routing functionality
            if (window.fleetManager) {
                window.fleetManager.apiKeyReady = true;
            }
        }

        // Load saved API key on page load
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('ors_api_key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                orsApiKey = savedKey;
                if (window.fleetManager) {
                    window.fleetManager.apiKeyReady = true;
                }
            }
        });
    </script>
</body>
</html>